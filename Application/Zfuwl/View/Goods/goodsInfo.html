<!DOCTYPE html>
<html>
<head>
    <include file='Public/top'/>
    <!-- 编辑器start -->
    <link rel="stylesheet" href="__PUBLIC__/plugins/editor/themes/default/default.css" />
    <script charset="utf-8" src="__PUBLIC__/plugins/editor/kindeditor-min.js"></script>
    <script charset="utf-8" src="__PUBLIC__/plugins/editor/lang/zh_CN.js"></script>
    <script>
        KindEditor.ready(function (K) {
            window.editor = K.create('#editor_id', {
                cssPath: '__PUBLIC__/plugins/editor/plugins/code/prettify.css',
                uploadJson: '__PUBLIC__/plugins/editor/php/upload_json.php',
                fileManagerJson: '__PUBLIC__/plugins/editor/php/file_manager_json.php',
                resizeType: 1,
                allowPreviewEmoticons: true,
                allowImageUpload: true,
            });
        });
    </script>
    <!-- 编辑器 end -->
        <style>
        /* 案例 */
        .fly-case-header{position: relative; height: 260px; text-align: center; background: #393D49;}
        .fly-case-year{position: absolute; top: 30px; width: 100%; line-height: 50px; font-size: 50px; text-align: center; color: #fff; font-weight: 300;}
        .fly-case-banner{position: absolute; left: 50%; top: 100px; width: 670px; margin-left: -335px;}
        .fly-case-btn{position: absolute; bottom: 30px; left: 0; width: 100%; text-align: center;}
        .fly-case-btn a{color: #fff;}
        .fly-case-btn .layui-btn-primary{background: none; color: #fff;}
        .fly-case-btn .layui-btn-primary:hover{border-color: #5FB878;}
        .fly-case-tab{margin-top: 20px; text-align: center;}
        .fly-case-tab span,
        .fly-case-tab span a{border-color: #009688;}
        .fly-case-tab .tab-this{background-color: #009688; color: #fff;}
        .fly-case-list{margin-top: 15px; font-size: 0;}
        .fly-case-list li,
        .layer-ext-ul li{display: inline-block; vertical-align: middle; *display: inline; *zoom:1; font-size: 14px; background-color: #fff;}
        .fly-case-list{width: 100%;}
        .fly-case-list li{width: 150px; margin: 0 15px 15px 0; padding: 10px;}
        .fly-case-list li:hover{box-shadow: 1px 1px 5px rgba(0,0,0,.1);}
        .fly-case-img{position: relative; display: block;}
        .fly-case-img img{width: 150px; height: 150px;}
        .fly-case-img .layui-btn{display: none; position: absolute; bottom: 20px; left: 50%; margin-left: -29px;}
        .fly-case-img:hover .layui-btn{display: inline-block;}
        .fly-case-list li h2{padding: 10px 0 5px; line-height: 22px; font-size: 18px; white-space: nowrap; overflow: hidden; text-align: center;}
        .fly-case-desc{height: 60px; line-height: 20px; font-size: 12px; color: #666; overflow: hidden;}
        .fly-case-info{position: relative; margin: 10px 0 0; padding: 10px 65px 0 45px; border-top: 1px dotted #eee;}
        .fly-case-info p{height:24px; line-height: 24px;}
        .fly-case-user{position: absolute; left: 0; top: 15px; width: 35px; height: 35px;}
        .fly-case-user img{width: 35px; height: 35px; border-radius: 100%;}
        .fly-case-info .layui-btn{position: absolute; right: 0; top: 15px;  padding: 0 15px;}
        .layer-ext-ul{margin: 10px; max-height: 500px;}
        .layer-ext-ul img{width: 50px; height: 50px; border-radius: 100%;}
        .layer-ext-ul li{margin: 8px;}
        .layer-ext-case .layui-layer-title{border: none; background-color: #009688; color: #fff;}
    </style>
</head>
<body>
<div class="admin-main">
    <fieldset class="layui-elem-field">
        <div class="test-table-reload-btn" style="margin-top: 10px;margin-left:15px;">
            <button type="button" class="layui-btn"><i class="layui-icon">&#xe628;</i>  {$info['name']} 商品管理</button>
            <button  type="button" class="layui-btn layui-btn-danger pull-right" onclick="history.go(-1);" style="float:right;"><i class="layui-icon">&#xe603;</i> 返回</button>
            <div style="clear:both;"></div>
        </div>
        <div class="layui-field-box">
            <form class="layui-form  layui-form-pane">
                <div class="layui-form-item">
                    <!-- <div class="layui-inline layui-form-item" pane="">
                       <label class="layui-form-label">商品类型</label>
                       <div class="layui-input-block">
                            <input type="radio" name="type" value="1" title="虚拟商品" <if condition="$info['type'] eq 1">checked</if>/>
                            <input type="radio" name="type" value="2" title="实物商品" <if condition="$info['type'] eq 2">checked</if> />
                       </div>
                    </div> -->
                    <!-- <div class="layui-inline">
                        <label class="layui-form-label">所属品牌</label>
                        <div class="layui-input-inline">
                            <select name="province" lay-ignore class="layui-input" id="province" onChange="get_city(this)">
                                <option value="0">--请选择--</option>
                                    <volist name="province" id="p">
                                    <option <if condition="$p['id'] eq $userDataInfo['province']"> selected </if> value="{$p.id}">{$p.name_cn}</option>
                                </volist>
                            </select>
                        </div>
                    </div> -->
                    <!-- <div class="layui-inline">
                        <label class="layui-form-label">所属供应商</label>
                        <div class="layui-input-inline">
                            <select name="city" lay-ignore id="city" class="layui-input"  onChange="get_area(this)">
                                <option value="0">--请选择--</option>
                                 <volist name="city" id="p">
                                    <option <if condition="$p['id'] eq $userDataInfo['city']"> selected </if>  value="{$p.id}">{$p.name_cn}</option>
                                </volist>
                            </select>
                        </div>
                    </div> -->
                </div>

                <!-- <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">一级分类</label>
                        <div class="layui-input-inline">
                            <select name="cat_id" lay-ignore class="layui-input" id="province" onChange="get_city(this)">
                                <option value="0">--请选择--</option>
                                    <foreach name="catList" item="v" key="k">
                                        <option value="{$v['cat_id']}" <if condition="$v['cat_id'] eq $info['cat_id']">selected</if>><?php echo str_repeat("--------",$v["level"]);?>{$v['name']}</option>
                                    </foreach>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">二级分类</label>
                        <div class="layui-input-inline">
                            <select name="city" lay-ignore id="city" class="layui-input"  onChange="get_area(this)">
                                <option value="0">--请选择--</option>
                                 <volist name="city" id="p">
                                    <option <if condition="$p['id'] eq $userDataInfo['city']"> selected </if>  value="{$p.id}">{$p.name_cn}</option>
                                </volist>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">三级分类</label>
                        <div class="layui-input-inline">
                            <select lay-ignore name="district" id="district" class="layui-input" onChange="get_twon(this)">
                                <option value="0">--请选择--</option>
                                <volist name="district" id="p">
                                    <option <if condition="$p['id'] eq $userDataInfo['district']"> selected </if> value="{$p.id}">{$p.name}</option>
                                </volist>
                            </select>
                        </div>
                    </div>
                </div> -->

                <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">商品价格</label>
                        <div class="layui-input-inline">
                             <input type="text" name="price" value="{$info['price']}" lay-verify="required" placeholder="请输入商品价格" autocomplete="off" onkeyup="this.value = this.value.replace(/[^\d.]/g, '')" onpaste="this.value=this.value.replace(/[^\d.]/g,'')" class="layui-input" />
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">商品PV值</label>
                        <div class="layui-input-inline">
                             <input type="text" name="pv" value="{$info['pv']}" lay-verify="required" placeholder="请输入商品价格" autocomplete="off" onkeyup="this.value = this.value.replace(/[^\d.]/g, '')" onpaste="this.value=this.value.replace(/[^\d.]/g,'')" class="layui-input" />
                        </div>
                    </div>
                    <div class="layui-inline">
                        <label class="layui-form-label">商品库存</label>
                        <div class="layui-input-inline">
                             <input type="text" name="stock" value="{$info['stock']}" lay-verify="required" placeholder="请输入商品库存" autocomplete="off" onkeyup="this.value = this.value.replace(/[^\d.]/g, '')" onpaste="this.value=this.value.replace(/[^\d.]/g,'')" class="layui-input" />
                        </div>
                    </div>
                </div>
                <!-- <div class="layui-form-item">
                    <div class="layui-inline">
                        <label class="layui-form-label">商品模型</label>
                        <div class="layui-input-inline">
                            <select name="type_id" lay-search="" lay-verify="required" id="type_id" autocomplete="off" lay-change lay-filter="type_id">
                                <option value="0">--请选择商品--</option>
                                <foreach name="goodsType" item="v" key="k">
                                    <option value="{$v['id']}" <if condition="$v['id'] eq $info['type_id']">selected</if>>{$v['name']}</option>
                                </foreach>
                            </select>
                        </div>
                    </div>
                    <div class="layui-inline layui-form-item" pane="">
                       <label class="layui-form-label">商品分类</label>
                       <div class="layui-input-block">
                            <input type="radio" name="type" value="1" title="报单" <if condition="$info['type'] eq 1">checked</if> <if condition="!$info">checked</if> />
                            <input type="radio" name="type" value="2" title="重销" <if condition="$info['type'] eq 2">checked</if> />
                            <input type="radio" name="type" value="3" title="积分换购" <if condition="$info['type'] eq 3">checked</if> />
                       </div>
                   </div>
                </div>
                <fieldset class="layui-elem-field">
                    <legend>商品规格</legend><div class="layui-field-box"><div id="goods_spec"></div></div>
                    <div class="layui-field-box"><div id="goods_spec_input"></div></div>
                </fieldset>
                               <fieldset class="layui-elem-field"><legend>商品属性</legend><div class="layui-field-box"><div id="attribute_input"></div></div></fieldset> -->
                <ul class="fly-case-list">
                    <li data-id="123">
                        <input type="hidden" name="picture" value="{$info['picture']|default='__PUBLIC__/images/not_adv.jpg'}" placeholder="商品主图" autocomplete="off" id="picture" class="layui-input" />
                        <a class="fly-case-img" href="javaScript:void(0);"><img src="{$info['picture']|default='__PUBLIC__/images/not_adv.jpg'}" alt="商品主图" class="picture checkImg" ></a>
                        <h5><a href="javaScript:void(0);">商品主图 800 * 800px</a></h5>
                        <button class="layui-btn layui-btn-sm uploadImg" type="button" lay-data="{field: 'picture',data:{dir:'Goods', field:'picture'}}"><i class="layui-icon">&#xe62f;</i> 上传首张商品主图</button>
                    </li>
                    <sapn id="uploadd_show">
                        <foreach name="info['goods_img']" key="k" item="v">
                            <li data-id="123">
                                <input type="hidden"  name="goods_img[{$k}]" value="{$v}" placeholder="商品配图" autocomplete="off" id="imga" class="layui-input" />
                                <a class="fly-case-img" href="javaScript:void(0);"><img src="{$v|default='__PUBLIC__/images/not_adv.jpg'}" alt="商品配图" class="imga checkImg" ></a>
                                <h5><a href="javaScript:void(0);">商品配图 800 * 800px</a></h5>
                                <a href="javaScript:void(0);" onclick="delImg(this);" data="{$v}" class="layui-btn layui-btn-sm layui-btn-danger"><i class="layui-icon">&#xe640;</i>删除本张商品配图</a>
                            </li>
                        </foreach>
                    </sapn>
                    <button class="layui-btn layui-btn-lg layui-btn-radius layui-btn-normal" type="button" id="uploadd"><i class="layui-icon">&#xe62f;</i>上传配图</button>
                </ul>

                <div class="layui-form-item">
                    <div class="layui-inline layui-form-item" pane="">
                       <label class="layui-form-label">是否显示</label>
                       <div class="layui-input-block">
                            <input type="radio" name="statu" value="1" title="显示" <if condition="$info['statu'] eq 1">checked</if> value="1" title="是" <if condition="!$info">checked</if>>
                            <input type="radio" name="statu" value="2" title="关闭" <if condition="$info['statu'] eq 2">checked</if> value="2" title="否" >
                       </div>
                   </div>
                    <div class="layui-inline layui-form-item" pane="">
                       <label class="layui-form-label">是否推荐</label>
                       <div class="layui-input-block">
                            <input type="radio" name="is_top" value="1" title="推荐" <if condition="$info['is_top'] eq 1">checked</if> value="1" title="是" <if condition="!$info">checked</if>>
                            <input type="radio" name="is_top" value="2" title="关闭" <if condition="$info['is_top'] eq 2">checked</if> value="2" title="否" >
                       </div>
                   </div>
                </div>

                <div class="layui-form-item">
                    <label class="layui-form-label">商品标题</label>
                    <div class="layui-input-block">
                        <input type="text" name="name" autocomplete="off" placeholder="分类名称"  value="{$info['name']}" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">商品关键词</label>
                    <div class="layui-input-block">
                        <input type="text" name="keywords" autocomplete="off" placeholder="分类关键词"  value="{$info['keywords']}" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">简要描述</label>
                    <div class="layui-input-block">
                        <textarea name="describe" placeholder="请输入简要描述" class="layui-textarea">{$info['describe']}</textarea>
                    </div>
                </div>
                <div class="layui-form-item layui-form-text">
                    <label class="layui-form-label">商品详情</label>
                    <div class="layui-input-block">
                        <textarea name="content" placeholder="请输入商品详情" class="layui-textarea" id="editor_id" style='height:300px;'>{$info['content']|htmlspecialchars_decode}</textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <input type="hidden" name="id" value="{$info['goods_id']}">
                        <button class="layui-btn" id="submitBtn" lay-submit lay-filter="goodsHandle">立即提交</button>
                        <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                    </div>
                </div>
            </form>
        </div>
    </fieldset>
</div>
<include file="Public/footer" />
<script>
    layui.use(['layer', 'form', 'upload','laydate'], function () {
        var form = layui.form, $ = layui.jquery,upload = layui.upload;
        upload.render({
            elem: '.uploadImg',
            url:'{:U("Api/uploadGoodsImg")}',
            before: function(){
            }
            ,done: function(res, index, upload){
                $('#'+this.data.field).val(res.data.src);
                $('.'+this.data.field).attr('src', res.data.src);
            }
        });
        var upload = layui.upload;
        var i=0;
        var uploadInst = upload.render({
            elem: '#uploadZ',
            url: '{:U("Api/uploadGoodsImg")}',
            data:{dir:'Goods', field:'goodsz'},
            field:'goodsz',
            before: function(obj) {
                obj.preview(function(index, file, result) {
                    $('.goods_img').attr('src', result); //图片链接（base64）
                });
            },
            done: function(res) {
                //如果上传失败
                if(res.code > 0) {
                    return layer.msg('上传失败');
                }
                $('#goods_img').val(res.data.src);
            },
            error: function() {
                //演示失败状态，并实现重传
                var demoText = $('#demoText');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-mini demo-reload">重试</a>');
                demoText.find('.demo-reload').on('click', function() {
                    uploadInst.upload();
                });
            }
        });
        //多图片上传
        upload.render({
            elem: '#uploadd',
            url: '{:U("Api/uploadGoodsImg")}',
            data:{dir:'Goods', field:'goodsd'},
            field:'goodsd',
            size:'3072',
            multiple: true,
            before: function(obj){
            }
            ,done: function(res){
                i++;
                if(res.code > 0) {
                    return layer.msg('上传失败');
                }
                $('#uploadd_show').append('<li data-id="123">' +
                    '<a class="fly-case-img" href="javaScript:void(0);"><img src="'+ res.data.src +'" class="imga checkImg" /></a>' +
                    '<h5><a href="javaScript:void(0);">商品配图 800 * 800px</a></h5>' +
                    '<a href="javaScript:void(0);" class="layui-btn layui-btn-sm layui-btn-danger" onclick="delImg(this);" data="'+res.data.src+'"><i class="layui-icon">&#xe640;</i> 删除本张商品配图</a>' +
                    '<input type="hidden" name="goods_img['+i+']" value="'+res.data.src+'">'+
                    '</li>');
            }
        });

        $('#submitBtn').click(function(){
            editor.sync();
        });
        //监听提交
        form.on('submit(goodsHandle)', function (data) {
            var ArticleInfo = data.field;
            var url = "{:U('')}";
            $.post(url, ArticleInfo, function (data) {
                if (data.status != 1) {
                    layer.msg(data.msg, {icon: 5});
                } else {
                    layer.msg(data.msg, {icon: 6, time: 2000}, function () {
                        history.go(-1);
                    });
                }
            });
            return false;//阻止表单跳转
        });
        /**
         * 监听 商品模型
         */
        form.on('select(type_id)', function (data) {
            //获取类型 规格
            var url = "{:U('Spec/getSpecByType')}";
            var type_id =data.value;
            var goods_id ="{$Think.get.id}";
            $.get(url,{type_id:type_id,goods_id:goods_id},function(data){
                $("#goods_spec").html(data.msg);
                addSpecListen();
                ajaxGetSpecInput();
            });
            // 获取类型属性
            getAttribute(type_id);

        });
    });

    // ajax 根据 商品类型 获取 商品属性
    function getAttribute(type_id){
        var url = "{:U('Spec/getAttributeByType')}";
        var goods_id ="{$Think.get.id}";
        $.get(url,{type_id:type_id,goods_id:goods_id},function(data){
//console.log(data);
            $("#attribute_input").html(data.msg);
            layui.use(['layer', 'form'],function(arg){
                var form = layui.form;
                form.render();
            });
        });
    }
//type_id
    $("#type_id").bind('change',function(data){
        //获取类型 规格
        var url = "{:U('Spec/getSpecByType')}";
        var type_id =this.value;
        var goods_id ="{$Think.get.id}";
        $.get(url,{type_id:type_id,goods_id:goods_id},function(data){
            $("#goods_spec").html(data.msg);
            addSpecListen();
            ajaxGetSpecInput();
        });
        // 获取类型属性
        getAttribute(type_id);
    });
    $(document).ready(function(){
        $("#type_id").change();
    });

    // 给规格项 添加点击事件
    function addSpecListen(){
        // 监听 商品模型
        $('#goods_spec button').bind('click',function(){
            if($(this).hasClass('layui-btn-success')){
                $(this).removeClass("layui-btn-success");
                $(this).addClass("layui-btn-primary");
            }else{
                $(this).addClass("layui-btn-success");
                $(this).removeClass("layui-btn-primary");
            }
            ajaxGetSpecInput();
        });
    }
    /**
     * 获取规格输入框
     */
    function ajaxGetSpecInput(){
        //设置全局变量 所选中的规格项
        var _spec_item_arr = {};
        $('#goods_spec button').each(function(){
            if($(this).hasClass('layui-btn-success')){
                var spec_id = $(this).attr('data-spec_id');
                var item_id = $(this).attr('data-item_id');
                if(!_spec_item_arr.hasOwnProperty(spec_id)){
                    _spec_item_arr[spec_id] = [];
                }
                _spec_item_arr[spec_id].push(item_id);
            }
        });
        console.log(_spec_item_arr);
        var goods_id = "{$Think.get.id}";
        var url = "{:U('Spec/getSpecInput')}";

        $.post(url,{spec_arr:_spec_item_arr,goods_id:goods_id},function(data){
            $("#goods_spec_input").html(data.msg);
        });
    }
    function delImg(obj)
    {
        var imgUrl = $(obj).attr('data');
        var url = "{:U('Api/delGoodsImg')}";
        $.post(url, {imgUrl:imgUrl,goods_id:'{$info["goods_id"]}'}, function (data) {
            if (data.status != 1) {
                layer.msg(data.msg, {icon: 5});
            } else {
                $(obj).parent().remove();
            }
        });
    }

</script>
</body>
</html>